---
title: "Racial Isolation Index"
author: "Fanmei Xia"
date: "2/22/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidycensus)
library(tidyverse)
library(tigris)
```


# Calculating Segregation
First we need to load some libraries. We use R to get all of our census data from the American Community Survey.

Below, we will use counties in New Jersey and use the 2018 ACS B03002 table. This table gives population estimates by race and Hispanic ethnicity.


```{r NJ, message=FALSE, warning=FALSE}
## Getting data from the 2011-2015 5-year ACS
# check for available variables in the census data (in this case American Community Survey)
ACS18var <- load_variables(2018, "acs5", cache = TRUE)
view(ACS18var)

## Loading ACS5 variables for 2018 from table B03002 and caching the dataset for faster future access.
race_table <-  get_acs(geography = "tract", year=2018, geometry = F, output="wide", table = "B03002", cache_table = T, state = "NJ")

trdat <- race_table %>%
  mutate(nhwhite=B03002_003E,
         nhblack=B03002_004E,
         nhasian=B03002_006E,
         nhother= B03002_005E+B03002_007E+B03002_008E+B03002_009E+B03002_010E,
         hisp=B03002_012E, 
         total=B03002_001E,
         year=2018,
         cofips=substr(GEOID, 1,5)) %>%
  select(GEOID, nhwhite, nhblack, nhasian, hisp, nhother, total, year, cofips )%>%
  arrange(cofips, GEOID)

#look at the first few cases
head(trdat)
```

```{r, message=FALSE, warning=FALSE}
#Merge with the interpolation 
path <- ("/Users/xiafm/Documents/GitHub/NJ-opioidenv/data_final/")
interpolation <- read_csv(paste0(path, "cw_areal_interpolation.csv"))
interpolation$TRACTID <- as.character(interpolation$TRACTID)
```

```{r, message=FALSE, warning=FALSE}
#We need the municipality-level totals for the total population and each race group
tr_mun <- left_join(x = interpolation, y = trdat, by = c("TRACTID" = "GEOID"))

weighted <- tr_mun %>%
  mutate(weighted_wht = nhwhite*prop_of_ct,
         weighted_blk = nhblack*prop_of_ct,
         weighted_asian = nhasian*prop_of_ct,
         weighted_oth = nhother*prop_of_ct,
         weighted_hisp = hisp*prop_of_ct)

mun_sum <- weighted %>%
  group_by(SSN) %>%
  mutate(mun_total=sum(total), 
         mun_wht=sum(weighted_wht),
         mun_blk=sum(weighted_blk), 
         mun_asian=sum(weighted_asian), 
         mun_oth=sum(weighted_oth), 
         mun_hisp=sum(weighted_hisp))

head(mun_sum)

```

# Group Segregation Measures in Municipalities

```{r, include=FALSE, collapse = TRUE, }
# Dissimilarity Index 
## Now we begin the segregation calculations, First we calculate the tract-specific contribution to the municipality dissimilarity index, then we use the tapply() function to sum the tract-specific contributions within municipalities. The Dissimilarity index for blacks and whites is: D=.5∗∑i ∣(bi/B) − (wi/W)∣ where bi is the number of blacks in each tract, B is the number of blacks in the municipality, wi is the number of whites in the tract, and W is the number of whites in the municipality.

mun.dis <- mun_sum %>%
  mutate(d.wb = abs(nhwhite/mun_wht - nhblack/mun_blk))%>%
  group_by(SSN)%>%
  summarise(dissim= .5*sum(d.wb, na.rm=T))

# Interaction Index
## Next is the interaction index for blacks and whites. In the calculation first population is minority population, second is non-minority population. The formula is: 
# Interaction = ∑i bi/B ∗ wi/ti

mun.int <- mun_sum %>%
  mutate(int.bw = (nhblack/mun_blk * nhwhite/total))%>%
  group_by(SSN)%>%
  summarise(inter.bw= sum(int.bw, na.rm=T))

# Isolation Index
## Next is is the isolation index for blacks. The formula is:
# Isolation=∑i bi/B ∗ bi/ti

co.isob<-merged%>%
  mutate(isob=(nhblack/co_blk * nhblack/total))%>%
  group_by(cofips)%>%
  summarise(iso.b= sum(isob, na.rm=T))

nj_seg<-list(co.dis, co.int, co.isob) %>% 
  reduce (left_join, by="cofips")
```

```{r, message=FALSE, warning=FALSE}
#We need the county-level totals for the total population and each race group
codat<-trdat%>%
  group_by(cofips)%>%
  summarise(co_total=sum(total), co_wht=sum(nhwhite), co_blk=sum(nhblack), co_asian=sum(nhasian), co_oth=sum(nhother), co_hisp=sum(hisp))

#we merge the county data back to the tract data by the county FIPS code
merged<-left_join(x=trdat,y=codat, by="cofips")
#have a look and make sure it looks ok
head(merged)
```

# Group Segregation Measures in Counties

```{r, include=FALSE, collapse = TRUE, }
# Dissimilarity Index 
## Now we begin the segregation calculations, First we calculate the tract-specific contribution to the county dissimilarity index, then we use the tapply() function to sum the tract-specific contributions within counties. The Dissimilarity index for blacks and whites is: D=.5∗∑i ∣(bi/B) − (wi/W)∣ where bi is the number of blacks in each tract, B is the number of blacks in the county, wi is the number of whites in the tract, and W is the number of whites in the county.

co.dis <- merged %>%
  mutate(d.wb=abs(nhwhite/co_wht - nhblack/co_blk))%>%
  group_by(cofips)%>%
  summarise(dissim= .5*sum(d.wb, na.rm=T))

# Interaction Index
## Next is the interaction index for blacks and whites. In the calculation first population is minority population, second is non-minority population. The formula is: 
# Interaction = ∑i bi/B ∗ wi/ti

co.int<-merged%>%
  mutate(int.bw=(nhblack/co_blk * nhwhite/total))%>%
  group_by(cofips)%>%
  summarise(inter.bw= sum(int.bw, na.rm=T))

# Isolation Index
## Next is is the isolation index for blacks. The formula is:
# Isolation=∑i bi/B ∗ bi/ti

co.isob<-merged%>%
  mutate(isob=(nhblack/co_blk * nhblack/total))%>%
  group_by(cofips)%>%
  summarise(iso.b= sum(isob, na.rm=T))

nj_seg<-list(co.dis, co.int, co.isob) %>% 
  reduce (left_join, by="cofips")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, collapse = TRUE,}
# get the shapefile
options(tigris_class = "sf")
nj_counties<- counties(state="NJ", cb=T, year=2010)
nj_counties$cofips<-substr(nj_counties$GEO_ID, 10,15)

nj_seg_dat<- geo_join(nj_counties, nj_seg, by_sp="cofips", by_df="cofips")
```

## Non-Hispanic Black Isolation Index

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# plot the black isolation index:
nj_seg_dat%>%
  ggplot() +
  geom_sf(aes(fill=iso.b)) +
  scale_fill_viridis_c(limits = c(0, 0.8)) +
  scale_color_viridis_c(limits = c(0, 0.8)) +
  ggtitle("Non-Hispanic Black Isolation Index", subtitle = "2018 ACS")

```

## Hispanic Isolation Index

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Dissimilarity Index - Hispanic
## Now we begin the segregation calculations, First we calculate the tract-specific contribution to the county dissimilarity index, then we use the tapply() function to sum the tract-specific contributions within counties. The Dissimilarity index for blacks and whites is: D=.5∗∑i ∣(hi/H) − (wi/W)∣ where hi is the number of Hispanics in each tract, H is the number of Hispanics in the county, wi is the number of whites in the tract, and W is the number of whites in the county.

co.dis.h <- merged %>%
  mutate(d.wh=abs(nhwhite/co_wht - hisp/co_hisp))%>%
  group_by(cofips)%>%
  summarise(dissim.h = .5*sum(d.wh, na.rm=T))

# Interaction Index
## Next is the interaction index for Hispanics and whites. In the calculation first population is minority population, second is non-minority population. The formula is: 
# Interaction = ∑i hi/H ∗ wi/ti

co.int.h <- merged %>%
  mutate(int.hw = (hisp/co_hisp * nhwhite/total)) %>%
  group_by(cofips)%>%
  summarise(inter.hw = sum(int.hw, na.rm=T))

# Isolation Index
## Next is is the isolation index for Hispanics. The formula is:
# Isolation=∑i hi/H ∗ hi/ti

co.iso.h <- merged %>%
  mutate(isoh = (hisp/co_hisp * hisp/total))%>%
  group_by(cofips)%>%
  summarise(iso.h= sum(isoh, na.rm=T))

nj_seg_h <- list(co.dis.h, co.int.h, co.iso.h) %>% 
  reduce (left_join, by="cofips")

# merge with the shapefile
nj_seg_dat_h<- geo_join(nj_counties, nj_seg_h, by_sp="cofips", by_df="cofips")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# plot the hispanic isolation index:
nj_seg_dat_h %>%
  ggplot() +
  geom_sf(aes(fill=iso.h)) +
  scale_fill_viridis_c(limits = c(0, 0.8)) +
  scale_color_viridis_c(limits = c(0, 0.8)) +
  ggtitle("Hispanic Isolation Index", subtitle = "2018 ACS")

```

## Asian Isolation Index

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Dissimilarity Index -- Asian
## Now we begin the segregation calculations, First we calculate the tract-specific contribution to the county dissimilarity index, then we use the tapply() function to sum the tract-specific contributions within counties. The Dissimilarity index for Asians and whites is: D=.5∗∑i ∣(ai/A) − (wi/W)∣ where ai is the number of Asians in each tract, A is the number of Asians in the county, wi is the number of whites in the tract, and W is the number of whites in the county.

co.dis.a <- merged %>%
  mutate(d.wa=abs(nhwhite/co_wht - nhasian/co_asian))%>%
  group_by(cofips)%>%
  summarise(dissim.a = .5*sum(d.wa, na.rm=T))

# Interaction Index - Asian
## Next is the interaction index for Hispanics and whites. In the calculation first population is minority population, second is non-minority population. The formula is: 
# Interaction = ∑i hi/H ∗ wi/ti

co.int.a <- merged %>%
  mutate(int.aw = (nhasian/co_asian * nhwhite/total)) %>%
  group_by(cofips)%>%
  summarise(inter.aw = sum(int.aw, na.rm=T))

# Isolation Index - Asian
## Next is is the isolation index for Hispanics. The formula is:
# Isolation=∑i hi/H ∗ hi/ti

co.iso.a <- merged %>%
  mutate(iso.a = (nhasian/co_asian * nhasian/total))%>%
  group_by(cofips)%>%
  summarise(iso.a = sum(iso.a, na.rm=T))

nj_seg_a <- list(co.dis.a, co.int.a, co.iso.a) %>% 
  reduce (left_join, by="cofips")

# merge with the shapefile
nj_seg_dat_a <- geo_join(nj_counties, nj_seg_a, by_sp="cofips", by_df="cofips")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# plot the Asian isolation index:
nj_seg_dat_a %>%
  ggplot() +
  geom_sf(aes(fill=iso.a)) +
  scale_fill_viridis_c(limits = c(0, 0.8)) +
  scale_color_viridis_c(limits = c(0, 0.8)) +
  ggtitle("Asian Isolation Index", subtitle = "2018 ACS")

```